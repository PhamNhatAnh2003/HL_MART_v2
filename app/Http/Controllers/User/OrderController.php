<?php

namespace App\Http\Controllers\User;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Product;
use App\Models\Order;
use App\Models\OrderItem;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Carbon;
use App\Http\Resources\OrderResource;
use App\Models\Voucher;

class OrderController extends Controller
{
    public function createOrder(Request $request)
    {
        $validated = $request->validate([
            'user_id' => 'required|exists:users,id',
            'payment_method' => 'required|string',
            'items' => 'required|array',
            'total_price' => 'required|numeric',
            'shipping_address' => 'required|string',
            'voucher_code' => 'nullable|string',
        ]);
    
        $discount = 0;
        $voucher = null;
        if (!empty($validated['voucher_code'])) {
            $voucher = Voucher::where('code', $validated['voucher_code'])
                ->where('is_active', true)
                ->where(function ($query) {
                    $now = now();
                    $query->whereNull('starts_at')->orWhere('starts_at', '<=', $now);
                })
                ->where(function ($query) {
                    $now = now();
                    $query->whereNull('expires_at')->orWhere('expires_at', '>=', $now);
                })
                ->first();
    
            if (!$voucher) {
                return response()->json([
                    'status' => false,
                    'message' => 'M√£ voucher kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.',
                ], 422);
            }
    
            if ($voucher->min_order > $validated['total_price']) {
                return response()->json([
                    'status' => false,
                    'message' => "ƒê∆°n h√†ng ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu " . number_format($voucher->min_order) . "ƒë ƒë·ªÉ √°p d·ª•ng voucher n√†y.",
                ], 422);
            }
    
            if ($voucher->max_usage !== null && $voucher->used >= $voucher->max_usage) {
                return response()->json([
                    'status' => false,
                    'message' => 'M√£ voucher ƒë√£ ƒë·∫°t gi·ªõi h·∫°n s·ªë l∆∞·ª£t s·ª≠ d·ª•ng.',
                ], 422);
            }
    
            $discount = $voucher->type === 'percent' 
                ? $validated['total_price'] * ($voucher->value / 100) 
                : $voucher->value;
    
            $discount = min($discount, $validated['total_price']);
        }
    
        $order = Order::create([
            'user_id' => $validated['user_id'],
            'status' => 'pending',
            'payment_method' => $validated['payment_method'],
            'total_price' => $validated['total_price'] - $discount,
            'discount' => $discount,
            'voucher_code' => $voucher->code ?? null,
            'shipping_address' => $validated['shipping_address'],
            'ordered_at' => Carbon::now(),
        ]);
    
        foreach ($validated['items'] as $item) {
            $totalItemPrice = $item['quantity'] * $item['price_at_time'];
    
            OrderItem::create([
                'order_id' => $order->id,
                'product_id' => $item['product_id'],
                'quantity' => $item['quantity'],
                'price_at_time' => $item['price_at_time'],
                'total_price' => $totalItemPrice,
            ]);
    
            $product = Product::findOrFail($item['product_id']);
    
            if ($product->stock < $item['quantity'] && $validated['payment_method'] === 'CK') {
                return response()->json([
                    'status' => false,
                    'message' => "Kh√¥ng th·ªÉ thanh to√°n b·∫±ng Chuy·ªÉn Kho·∫£n. S·∫£n ph·∫©m '{$product->name}' kh√¥ng ƒë·ªß h√†ng trong kho.",
                ], 400);
            }
    
            if ($product->stock < $item['quantity']) {
                return response()->json([
                    'status' => false,
                    'message' => "S·∫£n ph·∫©m '{$product->name}' kh√¥ng ƒë·ªß h√†ng trong kho.",
                ], 400);
            }
    
            $product->stock -= $item['quantity'];
            $product->sold += $item['quantity'];
            $product->save();
        }
    
        if (!empty($voucher)) {
            $voucher->used += 1;
            $voucher->save();
        }
    
        return response()->json([
            'status' => true,
            'message' => 'ƒê·∫∑t h√†ng th√†nh c√¥ng!',
            'order_id' => $order->id,
            'qr_url' => match ($validated['payment_method']) {
                'CK' => $this->generateMomoQr($order),
                'vnpay' => $this->generateVnpayUrl($order),
                default => null,
            },
        ]);
    }
    

private function generateVnpayUrl($order)
{
    $vnp_Url = "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html";
    $vnp_Returnurl = "http://localhost:8080/weblinhkienmaytinh/checkout";
    $vnp_TmnCode = "1VYBIYQP"; // T·ª´ VNPAY
    $vnp_HashSecret = "NOH6MBGNLQL9O9OMMFMZ2AX8NIEP50W1"; // T·ª´ VNPAY

    $vnp_TxnRef = $order->id;
    $vnp_OrderInfo = 'Thanh to√°n ƒë∆°n h√†ng #' . $order->id;
    $vnp_OrderType = 'billpayment';
    $vnp_Amount = $order->total_price * 100; // Nh√¢n 100 v√¨ VNPAY y√™u c·∫ßu
    $vnp_Locale = 'vn';
    $vnp_IpAddr = $_SERVER['REMOTE_ADDR'];

    $inputData = array(
        "vnp_Version" => "2.1.0",
        "vnp_TmnCode" => $vnp_TmnCode,
        "vnp_Amount" => $vnp_Amount,
        "vnp_Command" => "pay",
        "vnp_CreateDate" => date('YmdHis'),
        "vnp_CurrCode" => "VND",
        "vnp_IpAddr" => $vnp_IpAddr,
        "vnp_Locale" => $vnp_Locale,
        "vnp_OrderInfo" => $vnp_OrderInfo,
        "vnp_OrderType" => $vnp_OrderType,
        "vnp_ReturnUrl" => $vnp_Returnurl,
        "vnp_TxnRef" => $vnp_TxnRef,
    );

    ksort($inputData);
    $query = "";
    $hashdata = "";
    $i = 0;
    foreach ($inputData as $key => $value) {
        if ($i == 1) {
            $hashdata .= '&' . urlencode($key) . "=" . urlencode($value);
        } else {
            $hashdata .= urlencode($key) . "=" . urlencode($value);
            $i = 1;
        }
        $query .= urlencode($key) . "=" . urlencode($value) . '&';
    }

    $vnpSecureHash = hash_hmac('sha512', $hashdata, $vnp_HashSecret);
    $vnp_Url .= "?" . $query . 'vnp_SecureHash=' . $vnpSecureHash;

    return $vnp_Url;
}

public function getOrdersByUser($userId)
{
    $orders = Order::where('user_id', $userId)->orderBy('created_at', 'desc')->get();
    return response()->json(['orders' => $orders]);
}

public function getOrderDetail($id)
{
    $order = Order::with(['orderItems.product'])->findOrFail($id);

    $items = $order->orderItems->map(function ($item) {
        return [
            'id' => $item->id,
            'product_name' => $item->product->name,
            'quantity' => $item->quantity,
            'price_at_time' => $item->price_at_time,
            'avatar' => $item->product->avatar,
        ];
    });

    return response()->json([
        'order_items' => $items
    ]);
}

public function cancel($id)
{
    try {
        $order = Order::with('orderItems')->findOrFail($id);

        if ($order->status !== 'pending') {
            return response()->json([
                'success' => false,
                'message' => 'Ch·ªâ c√≥ th·ªÉ hu·ª∑ ƒë∆°n h√†ng ƒëang ch·ªù x·ª≠ l√Ω.'
            ], 400);
        }

        // ‚úÖ C·∫≠p nh·∫≠t l·∫°i s·ªë l∆∞·ª£ng t·ªìn kho v√† ƒë√£ b√°n
        foreach ($order->orderItems as $item) {
            $product = Product::find($item->product_id);
            if ($product) {
                $product->stock += $item->quantity;
                $product->sold -= $item->quantity;
                if ($product->sold < 0) {
                    $product->sold = 0; // ƒê·∫£m b·∫£o kh√¥ng √¢m
                }
                $product->save();
            }
        }

        // X√≥a order_items tr∆∞·ªõc khi x√≥a order
        $order->orderItems()->delete();

        // X√≥a ƒë∆°n h√†ng
        $order->delete();

        return response()->json([
            'success' => true,
            'message' => 'ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c hu·ª∑ v√† c·∫≠p nh·∫≠t l·∫°i kho.'
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => 'L·ªói khi hu·ª∑ ƒë∆°n h√†ng.',
            'error' => $e->getMessage()
        ], 500);
    }
}

public function getOrders(Request $request)
{
    $status = $request->query('status');
    $name = $request->query('name');
    $startDate = $request->query('start_date');
    $endDate = $request->query('end_date');

    $query = Order::query(); // üëà ƒê∆∞a l√™n ƒë·∫ßu ti√™n

    // L·ªçc theo ng√†y
    if ($startDate && $endDate) {
        $query->whereBetween('created_at', [$startDate . ' 00:00:00', $endDate . ' 23:59:59']);
    }

    // L·ªçc theo tr·∫°ng th√°i
    if ($status) {
        $query->where('status', $status);
    }

    // L·ªçc theo t√™n kh√°ch h√†ng t·ª´ b·∫£ng address
    if ($name) {
        $query->whereHas('address', function ($q) use ($name) {
            $q->where('receiver_name', 'like', '%' . $name . '%');
        });
    }

    // Eager load 'address'
    $orders = $query->with('address')->get();

    return response()->json([
        'success' => true,
        'data' => OrderResource::collection($orders),
    ]);
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
public function updateStatus(Request $request, $id)
{
    // T√¨m ƒë∆°n h√†ng theo ID
    $order = Order::find($id);
    if (!$order) {
        return response()->json(['success' => false, 'message' => 'ƒê∆°n h√†ng kh√¥ng t·ªìn t·∫°i'], 404);
    }

    // Ki·ªÉm tra tr·∫°ng th√°i m·ªõi
    $note = $request->input('note');
    $newStatus = $request->input('status');
    if (!$newStatus) {
        return response()->json(['success' => false, 'message' => 'Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá'], 400);
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
    $order->note = $note;
    $order->status = $newStatus;
    $order->save();

    return response()->json([
        'success' => true,
        'message' => 'Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!',
        'data' => $order
    ]);
}

private function generateMomoQr($order)
{
    // üß™ Gi·∫£ l·∫≠p link QR thanh to√°n Momo (b·∫°n c√≥ th·ªÉ t√≠ch h·ª£p SDK th·∫≠t ·ªü ƒë√¢y)
    return 'https://dummy-momo-qr.com/images/qr_3.png' . $order->id;
}

public function checkStock(Request $request)
{
    $items = $request->input('items');
    foreach ($items as $item) {
        $product = Product::find($item['product_id']);
        if (!$product || $product->stock < $item['quantity']) {
            return response()->json([
                'status' => false,
                'message' => "S·∫£n ph·∫©m '{$product->name}' kh√¥ng ƒë·ªß h√†ng trong kho.",
            ]);
        }
    }

    return response()->json(['status' => true]);
}

}



